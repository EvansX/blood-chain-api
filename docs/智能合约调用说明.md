# 智能合约调用说明
通过本接口，可以读取和调用血液链智能合约。

## 1.使用前提
接入方需要首先申请血液链账号，血液链联盟管理委员会会审核接入请求，批准后，将下发具备查询和调用合约权限的账号、APIKEY及APISECRET。

## 2.创建账号
### 2.1 申请机构账号
通过api申请账号后，需等待联盟委员会审核。

**调用方法**

HTTP POST

**请求地址**

http://139.159.199.162:8008/agency/addApply

参数：

- groupId:组idint
- agencyName:机构名称string
- agencyIp:机构服务器ip（如无服务器填0.0.0.0）string
- address:机构所在地址，省市string
- addressDetail:机构所在详细地址，区县门牌号等string
- agencyUserName:机构用户在血液链中想使用的用户名string
- agencyType:机构类型, 1为节点，0为非节点int
- phone:联系电话array

**返回：**

- code:返回码int
- message:提示信息string
- data:返回数据Object
  - agency_status:机构状态，0-审核未通过，1-待审核，2-审核中，3-审核通过int
例

```  js
        {
          "code":0,
          "message":"success",
          "data":
            {
              "agency_status":1,
              "agency_id":1003,
              "group_id":1,
              "agency_name":"cf",
              "agency_ip":"0.0.0.0",
              "address":"广东深圳",
              "address_detail":"福田保税区",
              "agency_user_name":"offical",
              "agency_type":1,
              "phone":"13800000000",
              "create_time":"2020-04-13T06:26:55.000Z",
              "modify_time":"2020-04-13T06:26:55.000Z"
            }
        }
      
```

### 2.2 申请普通账号
通过api申请普通献血者账号

**调用方法**

HTTP POST

**请求地址**

http://139.159.199.162:8008/user/addConsumer

**参数：**

- groupID: 1,
- userName: "asd",//账号名，例如原业务体系下的用户名
- description:"" //备注。属于哪个机构下的用户，例如血液云

**请求头：**
```js
headers: {
        APIKEY: "",//上一步申请机构账号获得的APIKEY
        APISECRET: ""
}
```

**返回：**
- code返回码String
- message提示信息String
- data返回数据Object
- user_id用户编号Integer
- user_name用户名称String
- address账户地址String
- group_id群组idInteger


```  js
        {
          "code": 0,
          "message": "success",
          "data": {
              "user_id": 700024,
              "user_name": "test_consumer2",
              "group_id": 1,
              "address": "0xa8be5a90289c2111e9d7cb553d9b1518c6a9dc66"
    }
}
      
```

## 3.API
**调用方法**
HTTP POST

**请求地址：**

http://139.159.199.162:8008/transaction/trans/handle

**请求头：**

需传入合法的APIKEY和APISECRET
``` js
    
      headers:{
        APIKEY:"",
        APISECRET:""
      }
```
### addOrganizationAccount
用于设置机构账号为血站、医院等身份，然后该账号才可调用合约。
**参数：**

- groupId:组idint
- userID:调用者账户的idint
- userName:调用者账户的名称string
- account:调用者账户公钥地址string
- contractName:合约名称（account）string
- contractAddress:合约地址（0x87f635d1d3434f6a6bf442591d13d8eb20d4996f）string
- funcName:调用方法名（addOrganizationAccount）string
- funcParam:
  - 机构号string
  - 账户地址address
  - 账户类型，1为血站，2为医院，3为卫健委，4为其他int

**返回：**
- code: 0
- message: "success"
- data:
  - status：0x0代表合约执行成功

例：
```js
    {
        "code":0,
        "message":"success",
        "data: {
            "transactionHash":"0x93d716d76eb3b8b9c843b1ebb61d827801085fa7741c5ef48b6858040d3f86af","transactionIndex":0,"blockHash":"0x77b74eb2df5de1c05c2ff1e6b2d3c56e4c404f8198cda6940f463cf5269b5d68","blockNumber":140,"gasUsed":155568,"contractAddress":"0x0000000000000000000000000000000000000000","root":"0x05e4c014d3c8989fcdb9b18fdbd576123b9a768532dd26d5769a8bf83d16335e","status":"0x0","message":null,"from":"0xf51e0d21477ef7652da21a18b4fb5a1424124425","to":"0x1cc24eb28fb610ca701c3968f3ef682635236aa9","input":"","output":"0x","logs":[{"removed":false,"logIndex":null,"transactionIndex":null,"transactionHash":null,"blockHash":null,"blockNumber":null,"address":"0x1cc24eb28fb610ca701c3968f3ef682635236aa9","data":"","type":null,"topics":["0xb1b9afe56e7ccf6464fc522f9a1ca49b0ab44cd1155dad192e9ed91f2f8362b3"],"logIndexRaw":null,"transactionIndexRaw":null,"blockNumberRaw":null}],"logsBloom":"","gasUsedRaw":"0x25fb0","statusOK":true,"transactionIndexRaw":"0x0","blockNumberRaw":"0x8c"}}
```

### AddDonateInfo
血站或管理员账号可调用，添加采血信息。
**参数：**

- groupId:组idint
- userID:调用者账户的idint
- userName:调用者账户的名称string
- account:调用者账户公钥地址string
- contractName:合约名称（donateBlood）string
- contractAddress:合约地址（0x1cc24eb28fb610ca701c3968f3ef682635236aa9）string
- funcName:调用方法名（AddDonateInfo）string
- funcParam:
  - DN码string
  - 献血者的身份证号string
  - 献血地点string
  - 采血类型string
  - 采血量string
  - 血量单位string
  - 时间string
  - 机构代码string

### CreatBloodBag
血站或管理员账号可调用，添加采血信息。
**参数：**

- groupId:组idint
- userID:调用者账户的idint
- userName:调用者账户的名称string
- account:调用者账户公钥地址string
- contractName:合约名称（business）string
- contractAddress:合约地址（0x7d1b34e658ba9e2594d9e41d995880152afae298）string
- funcName:调用方法名（CreatBloodBag）string
- funcParam:
  - DN码string
  - 产品码string
  - 血液品种类别代码string
  - 采集时间string
  - 制备时间string
  - 采集者工号string
  - 制备者工号string
  - 有效期string
  - Abo血型string
  - Rh血型string

### bloodSend
血站或管理员账号可调用，添加发血信息。
**参数：**

- groupId:组idint
- userID:调用者账户的idint
- userName:调用者账户的名称string
- account:调用者账户公钥地址string
- contractName:合约名称（business）string
- contractAddress:合约地址（0x7d1b34e658ba9e2594d9e41d995880152afae298）string
- funcName:调用方法名（bloodSend）string
- funcParam:
  - 发出机构代码string
  - 发入机构代码string
  - 发血业务单据号码string
  - dn码string
  - 产品码string
  - 时间string

### bloodSendBack
血站、医院或管理员账号可调用，添加退血信息。
**参数：**

- groupId:组idint
- userID:调用者账户的idint
- userName:调用者账户的名称string
- account:调用者账户公钥地址string
- contractName:合约名称（business）string
- contractAddress:合约地址（0x7d1b34e658ba9e2594d9e41d995880152afae298）string
- funcName:调用方法名（bloodSendBack）string
- funcParam:
  - 发出机构代码string
  - 发入机构代码string
  - 业务单据号码string
  - dn码string
  - 产品码string
  - 时间string

### bloodDispatch
血站、医院或管理员账号可调用，添加调剂信息。
**参数：**

- groupId:组idint
- userID:调用者账户的idint
- userName:调用者账户的名称string
- account:调用者账户公钥地址string
- contractName:合约名称（business）string
- contractAddress:合约地址（0x7d1b34e658ba9e2594d9e41d995880152afae298）string
- funcName:调用方法名（bloodDispatch）string
- funcParam:
  - 发出机构代码string
  - 发入机构代码string
  - 业务单据号码string
  - dn码string
  - 产品码string
  - 时间string

### dispatchAndChangeDn
血站或管理员账号可调用，添加调剂信息。
**参数：**

- groupId:组idint
- userID:调用者账户的idint
- userName:调用者账户的名称string
- account:调用者账户公钥地址string
- contractName:合约名称（business）string
- contractAddress:合约地址（0x7d1b34e658ba9e2594d9e41d995880152afae298）string
- funcName:调用方法名（dispatchAndChangeDn）string
- funcParam:
  - 机构代码string
  - 原始dn码string
  - 原始产品码string
  - 新dn码string
  - 新产品码string
  - 更换时间string

### getDonateResultByDn
传入献血者的献血码，获取献血记录和检测结果

**参数：**

- groupId:组idint
- userID:调用者账户的idint
- userName:调用者账户的名称string
- account:调用者账户公钥地址string
- contractName:合约名称（donateBlood）string
- contractAddress:合约地址（0x1cc24eb28fb610ca701c3968f3ef682635236aa9）string
- funcName:调用方法名（getDonateResultByDn）string
- funcParam:献血码array


**返回：**

- code:返回码int
- message:提示信息string
- data:返回数据Object
- DonateInfo
  - dn:dn码string
  - uid:用户身份证号string
  - place:献血地点string
  - bloodType:献血类型string
  - volume:献血量string
  - volUnit:血量单位string
  - makeTime:采集时间string
  - fac:采集机构代码string
例
```js
      
        {
          "code": 0,
          "message": "success",
          "data": {
            "DonateInfo":{
              "dn":"",
              "uid":"",
              "place":"",
              "bloodType":"",
              "volume":"",
              "volUnit":"",
              "makeTime":"",
              "fac":""
            }
          }
        }
```   
    
### getAllInfoByDn
传入血袋的献血码和产品码，获取献血记录和检测结果、血袋信息

**参数：**

- groupId:组idint
- userID:调用者账户的idint
- userName:调用者账户的名称string
- account:调用者账户公钥地址string
- contractName:'business'string
- contractAddress:合约地址（0x7d1b34e658ba9e2594d9e41d995880152afae298）string
- funcName:'getAllInfoByDn'string
- funcParam:献血码、产品码array


**返回：**

- code:返回码int
- message:提示信息string
- data:返回数据Object
- DonateInfo
  - dn:dn码string
  - uid:用户身份证号string
  - place:献血地点string
  - bloodType:献血类型string
  - volume:献血量string
  - volUnit:血量单位string
  - makeTime:采集时间string
  - fac:采集机构代码string
- BloodBag
  - code:血液品种类别代码string
  - colTime:采集时间string
  - prdTime:制备时间string
  - colOp:采集者工号string
  - prdOp:制备者工号string
  - expTime:有效期string
  - abo:血型string
  - rh:rh血型string


例
```js
      
        {
          "code": 0,
          "message": "success",
          "data": {
            "DonateInfo":{
              "dn":"",
              "uid":"",
              "place":"",
              "bloodType":"",
              "volume":"",
              "volUnit":"",
              "makeTime":"",
              "fac":""
            },
            "BloodBag"{
              "code":"",
              "colTime":"",
              "prdTime":"",
              "colOp":"",
              "prdOp":"",
              "expTime":"",
              "abo":"",
              "rh":""
          }
        }
```     
    
### getBloodOutboundInfoByDn
传入血袋的dn码和产品码，获取发血记录

**参数：**

- groupId:组idint
- userID:调用者账户的idint
- userName:调用者账户的名称string
- account:调用者账户公钥地址string
- contractName:'business'string
- contractAddress:合约地址（0x5e90a3f03d598314bf53828b3e39a73621f0f24d）string
- funcName:'getBloodOutboundInfoByDn'string
- funcParam:献血码、产品码array


**返回：**

- code:返回码int
- message:提示信息string
- data:返回数据Object
  - bbfac:血站机构代码string
  - medSsid:医院ssidstring
  - billid:发血业务单据号码string
  - time:时间string
例

```js  
        {
          "code": 0,
          "message": "success",
          "data": {
            bbfac;//血站机构代码
            medSsid;//医院ssid
            billid; // 发血业务单据号码
            time；//时间
          }
        }
```    
    